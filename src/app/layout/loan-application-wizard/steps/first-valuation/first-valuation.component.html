<div>
  <!-- Header Section -->
  <div class="header-section">
    <h2>
      <mat-icon color="primary">diamond</mat-icon>
      First Valuation
    </h2>
    <p class="subtitle">Add jewellery items and upload consolidated image for first valuation</p>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards" *ngIf="jewelleryList.length > 0">
    <div class="summary-card">
      <mat-icon class="card-icon">inventory_2</mat-icon>
      <div class="card-content">
        <span class="card-label">Total Items</span>
        <span class="card-value">{{ jewelleryList.length }}</span>
      </div>
    </div>
    <div class="summary-card">
      <mat-icon class="card-icon">scale</mat-icon>
      <div class="card-content">
        <span class="card-label">Total Gross Weight</span>
        <span class="card-value">{{ getTotal('grossWeight') | number:'1.2-2' }} g</span>
      </div>
    </div>
    <div class="summary-card">
      <mat-icon class="card-icon">straighten</mat-icon>
      <div class="card-content">
        <span class="card-label">Total Net Weight</span>
        <span class="card-value">{{ getTotal('netWeight') | number:'1.2-2' }} g</span>
      </div>
    </div>
    <div class="summary-card">
      <mat-icon class="card-icon">verified</mat-icon>
      <div class="card-content">
        <span class="card-label">Total Net Purity Weight</span>
        <span class="card-value">{{ getTotal('netPurityWeight') | number:'1.2-2' }} g</span>
      </div>
    </div>
  </div>

  <!-- Form Section -->
  <div class="form-section">
    <div class="section-header">
      <h3>
        <mat-icon>add_circle_outline</mat-icon>
        Add Jewellery Item
      </h3>
    </div>
    <form class="jewellery-form" [formGroup]="jewelleryForm">
      <div class="form-grid">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Jewellery Name</mat-label>
          <input matInput formControlName="jewelleryName" placeholder="e.g., Gold Chain, Ring" />
          <mat-icon matPrefix>label</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Quantity</mat-label>
          <input matInput type="number" formControlName="quantity" min="1" />
          <mat-icon matPrefix>confirmation_number</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Gross Weight (g)</mat-label>
          <input matInput type="number" formControlName="grossWeight" step="0.01" min="0" />
          <mat-icon matPrefix>scale</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Stone Weight (g)</mat-label>
          <input matInput type="number" formControlName="stoneWeight" step="0.01" min="0" />
          <mat-icon matPrefix>brightness_1</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field readonly-field">
          <mat-label>Net Weight (g)</mat-label>
          <input matInput type="number" formControlName="netWeight" readonly />
          <mat-icon matPrefix>calculate</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Karat</mat-label>
          <mat-select formControlName="karat">
            <mat-option *ngFor="let k of karatOptions" [value]="k.value">
              {{ k.label }} ({{ k.min }}% - {{ k.max }}%)
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Purity (%)</mat-label>
          <input matInput type="number" formControlName="purity" step="0.01" min="0" max="100" />
          <mat-icon matPrefix>percent</mat-icon>
          <mat-hint *ngIf="purityRange.min > 0">Range: {{ purityRange.min }}% - {{ purityRange.max }}%</mat-hint>
          <mat-error *ngIf="purityError">{{ purityError }}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field readonly-field">
          <mat-label>Net Purity Weight (g)</mat-label>
          <input matInput type="number" formControlName="netPurityWeight" readonly />
          <mat-icon matPrefix>verified</mat-icon>
        </mat-form-field>
      </div>

      <!-- Image Upload Prompt -->
      <div class="upload-prompt" *ngIf="showImageUploadPrompt && isValuationSaved">
        <mat-icon color="warn">warning</mat-icon>
        <span>Please upload the consolidated jewellery image to complete the first valuation.</span>
      </div>

      <!-- Action Buttons -->
      <div class="form-actions">
        <button mat-flat-button color="primary" (click)="addJewellery()" [disabled]="!jewelleryForm.valid">
          <mat-icon>add</mat-icon>
          Add Jewellery
        </button>
        <input type="file" hidden #imageInput (change)="uploadImage($event)" accept="image/*" />
        <button 
          mat-stroked-button 
          [color]="showImageUploadPrompt ? 'warn' : 'accent'" 
          (click)="imageInput.click()"
          [class.highlight-upload]="showImageUploadPrompt"
          [disabled]="!isValuationSaved">
          <mat-icon>{{ showImageUploadPrompt ? 'upload' : 'image' }}</mat-icon>
          {{ showImageUploadPrompt ? 'Upload Image (Required)' : 'Upload Consolidated Image' }}
        </button>
      </div>
    </form>
  </div>

  <!-- Jewellery Table Section -->
  <div class="table-section" *ngIf="jewelleryList.length > 0">
    <div class="section-header">
      <h3>
        <mat-icon>list</mat-icon>
        Jewellery Items ({{ jewelleryList.length }})
      </h3>
    </div>
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" class="jewellery-table">
        <ng-container matColumnDef="jewelleryName">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let element">
            <div class="cell-content">
              <mat-icon class="cell-icon">label</mat-icon>
              <span>{{ element.jewelleryName || 'N/A' }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Qty</th>
          <td mat-cell *matCellDef="let element">{{ element.quantity || 0 }}</td>
        </ng-container>

        <ng-container matColumnDef="grossWeight">
          <th mat-header-cell *matHeaderCellDef>Gross Wt (g)</th>
          <td mat-cell *matCellDef="let element">{{ element.grossWeight | number:'1.2-2' }}</td>
        </ng-container>

        <ng-container matColumnDef="stoneWeight">
          <th mat-header-cell *matHeaderCellDef>Stone Wt (g)</th>
          <td mat-cell *matCellDef="let element">{{ element.stoneWeight | number:'1.2-2' }}</td>
        </ng-container>

        <ng-container matColumnDef="netWeight">
          <th mat-header-cell *matHeaderCellDef>Net Wt (g)</th>
          <td mat-cell *matCellDef="let element">{{ element.netWeight | number:'1.2-2' }}</td>
        </ng-container>

        <ng-container matColumnDef="karat">
          <th mat-header-cell *matHeaderCellDef>Karat</th>
          <td mat-cell *matCellDef="let element">
            <span class="karat-badge">{{ element.karat || 'N/A' }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="purity">
          <th mat-header-cell *matHeaderCellDef>Purity %</th>
          <td mat-cell *matCellDef="let element">{{ element.purity | number:'1.2-2' }}</td>
        </ng-container>

        <ng-container matColumnDef="netPurityWeight">
          <th mat-header-cell *matHeaderCellDef>Net Purity Wt (g)</th>
          <td mat-cell *matCellDef="let element">{{ element.netPurityWeight | number:'1.2-2' }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <!-- Total Row -->
        <tr class="total-row" *ngIf="jewelleryList.length > 0">
          <td class="total-label" colspan="2">
            <strong>Total</strong>
          </td>
          <td class="total-value"><strong>{{ getTotal('grossWeight') | number:'1.2-2' }}</strong></td>
          <td class="total-value"><strong>{{ getTotal('stoneWeight') | number:'1.2-2' }}</strong></td>
          <td class="total-value"><strong>{{ getTotal('netWeight') | number:'1.2-2' }}</strong></td>
          <td></td>
          <td class="total-value"><strong>{{ getTotal('purity') | number:'1.2-2' }}</strong></td>
          <td class="total-value"><strong>{{ getTotal('netPurityWeight') | number:'1.2-2' }}</strong></td>
        </tr>
      </table>
    </div>
  </div>

  <!-- Image Preview Section -->
  <div class="image-section" *ngIf="uploadedImageUrl">
    <div class="section-header">
      <h3>
        <mat-icon>image</mat-icon>
        Consolidated Image Preview
      </h3>
    </div>
    <div class="image-preview-container">
      <img [src]="uploadedImageUrl" alt="Consolidated Jewellery Image" />
      <div class="image-overlay">
        <button mat-icon-button color="primary" (click)="imageInput.click()">
          <mat-icon>edit</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Submit Section -->
  <div class="submit-section" *ngIf="jewelleryList.length > 0">
    <button mat-raised-button color="accent" (click)="submitAll()" [disabled]="jewelleryList.length === 0" class="submit-button">
      <mat-icon>check_circle</mat-icon>
      Submit First Valuation
    </button>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="jewelleryList.length === 0 && !uploadedImageUrl">
    <mat-icon class="empty-icon">inventory_2</mat-icon>
    <h3>No Jewellery Items Added</h3>
    <p>Start by adding your first jewellery item using the form above</p>
  </div>
</div>
